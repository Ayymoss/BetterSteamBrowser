@using BetterSteamBrowser.Domain.Enums
@using BetterSteamBrowser.Domain.ValueObjects
@using Humanizer
@using BetterSteamBrowser.Business.ViewModels

<RadzenRow JustifyContent="JustifyContent.Center">
    <RadzenColumn SizeSM="12" SizeMD="10" SizeXX="8">
        <RadzenCard>
            <RadzenRow JustifyContent="JustifyContent.Center" class="rz-mb-4">
                <RadzenColumn SizeSM="12" SizeMD="12" SizeLG="3" SizeXL="6" SizeXX="6">
                    <RadzenText TextAlign="TextAlign.Start" TextStyle="TextStyle.DisplayH4" class="rz-mb-0 rz-mt-2">
                        @_titleText
                    </RadzenText>
                </RadzenColumn>
                <RadzenColumn SizeSM="12" SizeMD="12" SizeLG="9" SizeXL="6" SizeXX="6">
                    <RadzenRow AlignItems="AlignItems.End" JustifyContent="JustifyContent.End">
                        <RadzenColumn SizeSM="12" SizeMD="4">
                            <RadzenFormField Text="Select Region" Variant="Variant.Outlined" Style="width: 100%; min-width: 240px;">
                                <ChildContent>
                                    <RadzenDropDown TValue="string" @bind-Value="@_regionFilterSelected" Data="@_regionFilterData" AllowClear="true"
                                                    FilterAsYouType="true" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                    Change="OnDropdownChanged" Placeholder="Select Region"/>
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn SizeSM="12" SizeMD="4">
                            <RadzenFormField Text="Select Game" Variant="Variant.Outlined" Style="width: 100%; min-width: 240px;">
                                <ChildContent>
                                    <RadzenDropDown TValue="SteamGame" @bind-Value="@_gamesFilterSelected" Data="@_gamesFilterData" AllowClear="true"
                                                    FilterAsYouType="true" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                    Change="OnDropdownChanged" Placeholder="Select Game" LoadData="GameLoadData"/>
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn SizeSM="12" SizeMD="4">
                            <RadzenFormField Text="Search" Variant="Variant.Outlined" Style="width: 100%; min-width: 240px;">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="_searchString" Change="OnSearch"/>
                                </ChildContent>
                                <End>
                                    <RadzenIcon Icon="search" IconStyle="IconStyle.Info"/>
                                </End>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenColumn>
            </RadzenRow>
            <RadzenDataGrid @ref="_dataGrid" TItem="Server" IsLoading="@_isLoading" Count="@_count" Data="@_serverTable" LoadData="@TableLoadData"
                            Density="Density.Compact" AllowPaging="true" PageSize="25" AllowSorting="true" PagerAlwaysVisible="true"
                            PagerHorizontalAlign="HorizontalAlign.Center" PageSizeOptions="@PageSizes" ShowPagingSummary="true"
                            PagingSummaryFormat="Displaying page {0} of {1} <b>(total {2} records)</b>" AllowColumnResize="true"
                            RowClick="RowClickEvent" Style="min-height: 200px;" class="rz-selectable">
                <Columns>
                    <RadzenDataGridColumn TItem="Server" Property="Name" Title="Name" MinWidth="120px" Width="500px"/>
                    <RadzenDataGridColumn TItem="Server" Property="Address" Title="Address" MinWidth="100px" Width="175px"/>
                    <RadzenDataGridColumn TItem="Server" Property="SteamGameName" Title="Game" Sortable="false" MinWidth="60px"/>
                    <RadzenDataGridColumn TItem="Server" Property="Map" Title="Map" MinWidth="100px"/>
                    <RadzenDataGridColumn TItem="Server" Property="Players" Title="Players" SortOrder="SortOrder.Descending" MinWidth="80px">
                        <Template Context="context">
                            @context.Players.ToString("N0")/@context.MaxPlayers.ToString("N0")
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Server" Property="Country" Title="Country" MinWidth="100px">
                        <Template Context="context">
                            @context.Country.Humanize().Transform(To.TitleCase)
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Server" Property="LastUpdated" Title="Last Seen" MinWidth="120px">
                        <Template Context="context">
                            @context.LastUpdated.Humanize()
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Server" Property="Created" Title="First Seen" MinWidth="120px">
                        <Template Context="context">
                            <RadzenText TextStyle="TextStyle.Body2" Text="@context.Created.Humanize()"
                                        MouseEnter="@(args => ShowTooltip(args, new TooltipOptions {Position = TooltipPosition.Left}, context.Created.ToString("yyyy-MM-dd @ HH:mm:ss")))">
                            </RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                    @if (Manager)
                    {
                        <RadzenDataGridColumn TItem="Server" Sortable="false" Property="AveragePlayers" Title="Player Avg." MinWidth="100px">
                            <Template Context="context">
                                <RadzenText TextStyle="TextStyle.Body2">@context.AveragePlayers.ToString("N2")</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Server" Property="PlayerStandardDeviation" Title="Player Std." MinWidth="100px">
                            <Template Context="context">
                                <RadzenText TextStyle="TextStyle.Body2" class="@PlayerStandardDeviationColour(context.PlayerStandardDeviation)">
                                    @(context.PlayerStandardDeviation?.ToString("N2") ?? "--")
                                </RadzenText>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Server" Property="PlayerGlobalStandardDeviationRatio" Title="Player Glo. Rat." MinWidth="120px">
                            <Template Context="context">
                                <RadzenText TextStyle="TextStyle.Body2" class="@PlayerGlobalStandardDeviationRatioColour(context.PlayerGlobalStandardDeviationRatio)">
                                    @(context.PlayerGlobalStandardDeviationRatio?.ToString("N2") ?? "--")
                                </RadzenText>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Server" Sortable="false" Title="Player Bounds" MinWidth="160px">
                            <Template Context="context">
                                @{
                                    var hasBounds = context.UpperBoundPlayers > 0;
                                }
                                <RadzenText TextStyle="TextStyle.Body2">
                                    @(hasBounds ? $"LB: {context.LowerBoundPlayers:N0}, UB: {context.UpperBoundPlayers:N0}" : "--")
                                </RadzenText>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Server" Sortable="false" Title="Player Hist." MinWidth="120px">
                            <Template Context="context">
                                @{
                                    var historyCount = context.PlayerHistory?.Count;
                                    var historyTooltip = "No history available.";
                                    if (historyCount is not 0)
                                        historyTooltip = string.Join(", ", context.PlayerHistory!.Select((value, index) => $"{index}:{value:N0}"));
                                }
                                <RadzenText TextStyle="TextStyle.Body2" Text="@($"{historyCount ?? 0} item(s)")"
                                            MouseEnter="@(args => ShowTooltip(args, new TooltipOptions {Duration = null, Position = TooltipPosition.Left}, historyTooltip))"/>
                            </Template>
                        </RadzenDataGridColumn>
                    }
                    @if (!string.IsNullOrWhiteSpace(UserId) && !Manager)
                    {
                        <RadzenDataGridColumn TItem="Server" Width="40px" TextAlign="TextAlign.Center" Sortable="false" Frozen="true">
                            <Template Context="iContext">
                                <RadzenButton Icon="@(iContext.Favourite ? "star" : "star_border")" ButtonStyle="@(iContext.Favourite ? ButtonStyle.Success : ButtonStyle.Primary)" Shade="Shade.Lighter" Size="ButtonSize.ExtraSmall"
                                              MouseEnter="@(args => ShowTooltip(args, new TooltipOptions {Position = TooltipPosition.Left}, iContext.Favourite ? "Favourited" : "Not Favourited"))"/>
                            </Template>
                        </RadzenDataGridColumn>
                    }
                </Columns>
                <EmptyTemplate>
                    <RadzenText TextAlign="TextAlign.Center" TextStyle="TextStyle.H6" class="rz-my-4" Text="There are no servers..."/>
                </EmptyTemplate>
            </RadzenDataGrid>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>
